{% extends "pages/base_adminlte.html" %}
{% load static %}

{% block title %}Liste des étudiants{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'etudiants_list' %}">Étudiants</a></li>
{% endblock %}

{% block breadcrumb_active %}Liste{% endblock %}

{% block content %}

<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-filter"></i> Filtres</h3>
        <div class="card-tools">
          <button type="button" class="btn btn-tool" data-card-widget="collapse">
            <i class="fas fa-minus"></i>
          </button>
        </div>
      </div>
      <div class="card-body">
        <form method="get" class="form-horizontal">
          <div class="row">
            <div class="col-md-6 col-lg-4">
              <div class="form-group">
                <label>Département</label>
                <select id="departement-select" class="form-control" name="departement">
                  <option value="">-- Sélectionner --</option>
                  {% for d in departements %}
                    <option value="{{ d.id }}" {% if d.id == selected_departement %}selected{% endif %}>{{ d.nom }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-md-6 col-lg-4">
              <div class="form-group">
                <label>Filière</label>
                <select id="filiere-select" class="form-control" name="filiere">
                  <option value="">-- Sélectionner --</option>
                  {% for f in filieres %}
                    <option value="{{ f.id }}" {% if f.id == selected_filiere %}selected{% endif %}>{{ f.nom }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-md-6 col-lg-4">
              <div class="form-group">
                <label>Niveau</label>
                <select id="niveau-select" class="form-control" name="niveau">
                  <option value="">-- Sélectionner --</option>
                  {% for n in niveaux %}
                    <option value="{{ n.id }}" {% if n.id == selected_niveau %}selected{% endif %}>{{ n.nom }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-md-6 col-lg-4">
              <div class="form-group">
                <label>Semestre</label>
                <select id="semester-select" class="form-control" name="semester">
                  <option value="1" {% if selected_semester == 1 %}selected{% endif %}>Semestre 1</option>
                  <option value="2" {% if selected_semester == 2 %}selected{% endif %}>Semestre 2</option>
                </select>
              </div>
            </div>
            <div class="col-md-6 col-lg-4">
              <div class="form-group">
                <label>UE (optionnelle)</label>
                <select id="ue-select" class="form-control" name="ue">
                  <option value="">-- Sélectionner --</option>
                  {% for u in ues %}
                    <option value="{{ u.id }}" {% if u.id == selected_ue %}selected{% endif %}>{{ u.code }} - {{ u.nom }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-md-6 col-lg-4">
              <div class="form-group">
                <label>Trier par</label>
                <select id="sort-select" class="form-control" name="sort">
                  <option value="nom" {% if sort == 'nom' %}selected{% endif %}>Nom</option>
                  <option value="matricule" {% if sort == 'matricule' %}selected{% endif %}>Matricule</option>
                  {% if selected_ue %}
                    <option value="note" {% if sort == 'note' %}selected{% endif %}>Note (UE sélectionnée)</option>
                  {% endif %}
                </select>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-search"></i> Appliquer les filtres
              </button>
              <a href="{% url 'etudiant_add' %}" class="btn btn-success">
                <i class="fas fa-plus"></i> Ajouter étudiant
              </a>
              {% if user.is_staff and selected_niveau and selected_ue %}
                <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#importModal">
                  <i class="fas fa-upload"></i> Importer notes
                </button>
                <a class="btn btn-warning" href="{% url 'notes_export_excel' %}?ue_id={{ selected_ue }}&niveau_id={{ selected_niveau }}">
                  <i class="fas fa-download"></i> Exporter notes
                </a>
              {% endif %}
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Students Table -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-users"></i> Étudiants</h3>
      </div>
      <div class="card-body table-responsive p-0">
        {% if rows %}
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Matricule</th>
              {% if selected_ue %}<th class="text-center">Note (final)</th>{% endif %}
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for row in rows %}
            <tr>
              <td>{{ row.etudiant.nom }}</td>
              <td>{{ row.etudiant.matricule }}</td>
              {% if selected_ue %}
                <td class="text-center">
                  {% if row.note_final is not None %}
                    <span class="badge badge-success">{{ row.note_final|floatformat:2 }}</span>
                  {% else %}
                    <span class="badge badge-secondary">—</span>
                  {% endif %}
                </td>
              {% endif %}
              <td class="text-center">
                <a class="btn btn-sm btn-info" href="{% url 'moyenne' row.etudiant.id %}?next={{ current_path|urlencode }}">
                  <i class="fas fa-eye"></i> Voir
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="p-3 text-center text-muted">
          <p class="mb-0">Aucun étudiant trouvé</p>
        </div>
        {% endif %}
      </div>
      {% if students_page %}
      <div class="card-footer">
        <nav aria-label="Page navigation">
          <ul class="pagination pagination-sm mb-0">
            {% if students_page.has_previous %}
              <li class="page-item"><a class="page-link" href="?{% if base_query %}{{ base_query }}&{% endif %}page={{ students_page.previous_page_number }}">« Précédent</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">« Précédent</span></li>
            {% endif %}

            {% for num in students_page.paginator.page_range %}
              {% if students_page.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
              {% else %}
                <li class="page-item"><a class="page-link" href="?{% if base_query %}{{ base_query }}&{% endif %}page={{ num }}">{{ num }}</a></li>
              {% endif %}
            {% endfor %}

            {% if students_page.has_next %}
              <li class="page-item"><a class="page-link" href="?{% if base_query %}{{ base_query }}&{% endif %}page={{ students_page.next_page_number }}">Suivant »</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Suivant »</span></li>
            {% endif %}
          </ul>
        </nav>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- AJAX cascade script -->
<script src="{% static 'notes/js/etudiants_filters.js' %}"></script>

<!-- Import Modal -->
{% if user.is_staff and selected_niveau and selected_ue %}
<div class="modal fade" id="importModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-upload"></i> Importer les notes</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="importForm" enctype="multipart/form-data" method="post" action="{% url 'notes_import_excel' %}">
        {% csrf_token %}
        <div class="modal-body">
          <div class="form-group">
            <label for="excelFile">Fichier Excel</label>
            <input type="file" class="form-control" id="excelFile" name="file" accept=".xlsx,.xls" required>
            <small class="text-muted">Format: Nom, Matricule, CC, TP, SN (valeurs 0-20)</small>
          </div>
          <input type="hidden" name="niveau_id" value="{{ selected_niveau }}">
          <input type="hidden" name="ue_id" value="{{ selected_ue }}">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary"><i class="fas fa-check"></i> Importer</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}
